# MongoDB Sharding Examples

## Коллекция `orders`

**Составной ключ:**  
```js
{ geo: 1, customerId: 1, orderId: "hashed" }
```

### Примеры команд
```js
// Создание ключа шардирования
sh.enableSharding("shop");
sh.shardCollection("shop.orders", { geo: 1, customerId: 1, orderId: "hashed" });
// Для вставки нужно заранее вычислять orderId

// Индексы
db.orders.createIndex({ geo: 1, customerId: 1, orderId: "hashed" });
db.orders.createIndex({ geo: 1, customerId: 1, orderId: 1 }, { unique: true });

// Объяснение
// Используя ключ {geo: 1, customerId: 1, orderId: "hashed"},
// получаем распределение по геозоне с равномерным распределением по orderId.
// При вставке будем равномерно заполнять шарды.
// При поиске в большинстве случаев будем знать geo, так что сразу идём в нужный шард.
```

---

## Коллекция `products`

**Ключ шардирования:**  
```js
{ category: 1, price: 1, _id: "hashed" }
```

### Примеры команд
```js
sh.enableSharding("shop");
sh.shardCollection("shop.products", { category: 1, price: 1, _id: "hashed" });

// Индексы
db.products.createIndex({ category: 1, price: 1, _id: "hashed" });
db.products.createIndex({ category: 1, price: 1, _id: 1 });

// Объяснение
// Используя ключ {category: 1, price: 1, _id: "hashed"},
// получаем локализацию товаров по категориям с равномерным распределением по _id.
// При поиске по category и price идём в конкретные шарды.
// При обновлении остатков нужно знать все три поля ключа.

// 1) Частые обновления остатков при покупках
db.products.updateOne(
  {
    category: "phones",
    price: 39990,
    _id: ObjectId("64fcd3a8b97f5e1f2a4d1234")
  },
  { $inc: { "stock.EKAT": -1 } }
);

// 2) Поиск товаров по категориям и диапазону цен
db.products.find({
  category: "phones",
  price: { $gte: 30000, $lte: 50000 }
});
```

---

## Коллекция `carts`

**Особенности:**  
- может быть session_id (гость) или user_id (авторизованный пользователь);  
- используется поле `owner` = session_id | user_id.  

**Ключ шардирования:**  
```js
{ owner: 1, status: 1 }
```

### Примеры команд
```js
sh.enableSharding("shop");
sh.shardCollection("shop.carts", { owner: 1, status: 1 });

// Индексы
db.carts.createIndex({ owner: 1, status: 1 });

// Объяснение
// Используя ключ {owner: 1, status: 1},
// получаем локализацию корзин по владельцу (session_id или user_id) и статусу.
// При поиске и обновлении корзины по owner и status идём в конкретный шард.
// Все операции с корзиной требуют знания owner и status.

// 1) Добавление или замена товара в корзине
db.carts.updateOne(
  {
    status: "active",
    owner: "sess_abc",
    "items.product_id": { $ne: ObjectId("64fcd3a8b97f5e1f2a4d1234") }
  },
  {
    $push: {
      items: { product_id: ObjectId("64fcd3a8b97f5e1f2a4d1234"), quantity: 1 }
    },
    $set: { updated_at: new Date() }
  }
);

db.carts.updateOne(
  {
    status: "active",
    owner: "sess_abc",
    "items.product_id": ObjectId("64fcd3a8b97f5e1f2a4d1234")
  },
  {
    $set: { "items.$.quantity": 3, updated_at: new Date() }
  }
);

// 2) Удаление товара из корзины
db.carts.updateOne(
  {
    status: "active",
    owner: "sess_abc"
  },
  {
    $pull: { items: { product_id: ObjectId("64fcd3a8b97f5e1f2a4d1234") } },
    $set: { updated_at: new Date() }
  }
);

// 3) Слияние гостевой корзины в пользовательскую
// - получаем гостевую { owner: session_id, status: "active" }
// - обновляем/создаём пользовательскую { owner: user_id, status: "active" }
// - объединяем items и помечаем гостевую как abandoned

// 4) Отметка корзины как заказанной
db.carts.updateOne(
  { owner: "sess_abc", status: "active" },
  {
    $set: {
      status: "ordered",
      updated_at: new Date()
    }
  }
);
```
