# Задание 10.1. Критически важные данные и обоснование применения Cassandra

## Критически важные части данных

### 1. Заказы (Orders)
**Критичность:** Высокая по целостности и скорости

**Основные поля:** order_id, customer_id, created_at, items, status, total_amount, geo_zone

**Что делаем:** Быстро создаём заказы, ищем историю по customer_id, показываем статус заказа

**Что важно:**
- Потерять заказ нельзя — нужна высокая целостность
- История заказов должна читаться быстро
- Заказы могут создаваться в разных геозонах — нужна геораспределённость
- **Транзакционная логика:** При создании заказа необходимо атомарно обновлять остатки товаров. Если сервис не видит актуальное состояние остатков, есть риск продать товар, которого уже нет на складе. Нужна синхронизация между созданием заказа и обновлением остатков.

### 2. Корзины (Carts)
**Критичность:** Высокая по скорости, средняя по целостности

**Основные поля:** _id, user_id/session_id, items, status ("active"|"ordered"|"abandoned"), expires_at (TTL)

**Что делаем:** Создаём корзину, получаем активную корзину, добавляем/удаляем товары, сливаем гостевую корзину в пользовательскую

**Что важно:**
- Пользователь не должен ждать при добавлении товара — низкая задержка критична
- Корзина обновляется очень часто
- Старые корзины должны удаляться автоматически через TTL

### 3. Товары (Products)
**Критичность:** Высокая по скорости чтения, высокая по целостности для остатков

**Основные поля:** product_id, name, category, price, stock_by_geo, attributes

**Что делаем:** Обновляем остатки по геозонам, ищем товары по категориям и цене, показываем описание товара

**Что важно:**
- Каталог читают постоянно — нужны быстрые листинги и фильтры
- Нужно контролировать остатки по геозонам, чтобы не продать больше, чем есть
- **Транзакционная логика:** Остатки должны обновляться атомарно при создании заказа. При оформлении заказа нужно проверить наличие товара и заблокировать/уменьшить остаток в рамках одной транзакции с созданием заказа. Используем Lightweight Transactions (LWT) для проверки и обновления остатков.

## Обоснование применения Cassandra

**CAP-теорема:** В Cassandra выбираем Availability + Partition Tolerance вместо строгой Consistency. Это значит, что система остаётся доступной при проблемах с сетью, а согласованность обеспечиваем через кворум.

**Почему Cassandra подходит:**

**Заказы:**
- Масштабируется линейно при добавлении нод
- Можно размещать реплики в разных дата-центрах
- QUORUM даёт достаточную согласованность
- Lightweight Transactions (LWT) позволяют атомарно создавать заказ и обновлять остатки

**Корзины:**
- Горизонтальное масштабирование без решардинга
- Встроенный TTL для автоматического удаления
- Оптимизирована для частых записей

**Товары:**
- Можно создать несколько таблиц под разные запросы (денормализация)
- Шардинг по категориям предотвращает "горячие" партиции
- Эффективное чтение для каталога
- Остатки хранятся по геозонам
- Lightweight Transactions (LWT) с условиями IF позволяют атомарно проверять и обновлять остатки при создании заказа
- LWT с SERIAL consistency level обеспечивает линейную согласованность для критичных операций с остатками

